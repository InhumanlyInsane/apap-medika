<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <title>APAP Medika</title>
    <object th:include="~{fragments/common :: css}" th:remove="tag"></object>
    <object th:include="~{fragments/common :: js}" th:remove="tag"></object>
</head>


<body>
    <nav th:replace="~{fragments/navbar :: navbar}"></nav>

    <div class="container mt-4 mb-5">
        <h2 class="text-center mb-4">Appointments</h2>
        
        <div class="card">
            <div class="card-body">
                <form id="statForm" class="row g-3 mb-4">
                    <div class="col-md-4">
                        <label for="period" class="form-label">Period</label>
                        <select id="period" class="form-select">
                            <option value="quarterly">Quarter</option>
                            <option value="monthly">Monthly</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="year" class="form-label">Year</label>
                        <input type="number" class="form-control" id="year" value="2024" min="2000" max="2100">
                    </div>
                    <div class="col-md-4 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary">Apply</button>
                    </div>
                </form>
                
                <canvas id="appointmentChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        let chart;
        
        document.getElementById('statForm').addEventListener('submit', function(e) {
            e.preventDefault();
            fetchData();
        });
        
        function fetchData() {
            const period = document.getElementById('period').value;
            const year = document.getElementById('year').value;
        
            fetch(`/api/appointment/stat?period=${period}&year=${year}`)
                .then(response => response.json())
                .then(data => updateChart(data, period, year));
        }
        
        function updateChart(data, period, year) {
            const ctx = document.getElementById('appointmentChart').getContext('2d');
            let labels;
            if (period === 'monthly') {
                labels = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            } else if (period === 'quarterly') {
                labels = ['Q1', 'Q2', 'Q3', 'Q4'];
            }
        
            // Ensure data is an array of numbers
            const chartData = Array.isArray(data) ? data : labels.map(label => data[label] || 0);
        
            if (chart) {
                chart.destroy();
            }
        
            const maxValue = Math.max(...chartData, 10); // Ensure a minimum max value of 10
            const yAxisMax = Math.ceil(maxValue / 10) * 10;  // Round up to nearest ten
        
            chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Number of Appointments',
                        data: chartData,
                        backgroundColor: 'rgba(142, 68, 173, 0.8)',
                        borderColor: 'rgba(142, 68, 173, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: yAxisMax,
                            ticks: {
                                stepSize: Math.max(1, Math.ceil(yAxisMax / 10))
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: `Appointments in ${year} (${period === 'monthly' ? 'Monthly' : 'Quarterly'})`
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    }
                }
            });
        
        }
        
        // Initial fetch
        fetchData();
    </script>
</body>
</html>