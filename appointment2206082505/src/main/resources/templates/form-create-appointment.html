<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <title>APAP Medika</title>
    <object th:include="~{fragments/common :: css}" th:remove="tag"></object>
    <object th:include="~{fragments/common :: js}" th:remove="tag"></object>
</head>

<body>
    <nav th:replace="~{fragments/navbar :: navbar}"></nav>

    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-body">
                        <h2 class="text-center mb-4" th:text="'New Appointment for ' + ${patient.name}"></h2>
                        <form th:action="@{/appointment/{nik}/create(nik=${patient.nik})}" th:object="${appointmentDTO}" method="POST">
                            <div class="mb-3">
                                <label for="doctor" class="form-label fw-bold">Doctor</label>
                                <select class="form-select" id="doctor" name="doctorId" th:field="*{doctorId}">
                                    <option value="" class="text-muted">Select a doctor</option>
                                    <option th:each="doctor : ${allDoctors}" th:value="${doctor.id}"
                                        th:text="${doctor.name}" th:data-schedule="${doctor.schedule}"></option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="schedule" class="form-label fw-bold">Schedule</label>
                                <select class="form-select" id="schedule" name="scheduleDate" th:field="*{appointmentDate}" disabled>
                                    <option value="" class="text-muted">Select a schedule</option>
                                </select>
                            </div>

                            <div class="mb-3">
                                <button type="submit" class="btn btn-primary">Submit</button>
                                <a class="btn btn-danger" href="/appointment/all">Cancel</a>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script th:inline="javascript">
        const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
        const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
        
        function getNextFourWeeks(dayOfWeek) {
            const today = new Date();
            const dates = [];
            let current = new Date(today.getTime());
            current.setDate(today.getDate() + (dayOfWeek - today.getDay() + 7) % 7);
            
            for (let i = 0; i < 4; i++) {
                dates.push(new Date(current.getTime()));
                current.setDate(current.getDate() + 7);
            }
            
            return dates;
        }
        
        function formatDate(date) {
            const dayName = dayNames[date.getDay()];
            const day = date.getDate();
            const month = monthNames[date.getMonth()];
            const year = date.getFullYear();
            return `${dayName}, ${day} ${month} ${year}`;
        }
        
        $(document).ready(function() {
            $('#doctor').change(function() {
                const scheduleSelect = $('#schedule');
                scheduleSelect.empty().append('<option value="">Select a schedule</option>');
                
                const selectedOption = $(this).find('option:selected');
                const schedule = selectedOption.data('schedule');
                
                if (schedule && schedule.length > 0) {
                    const fourWeekDates = [];
                    schedule.forEach(day => {
                        const dates = getNextFourWeeks(day);
                        fourWeekDates.push(...dates);
                    });
                    
                    fourWeekDates.sort((a, b) => a - b);
                    
                    fourWeekDates.forEach(date => {
                        const formattedDate = formatDate(date);
                        scheduleSelect.append(`<option value="${date.toISOString()}">${formattedDate}</option>`);
                    });
                    scheduleSelect.prop('disabled', false);
                } else {
                    scheduleSelect.prop('disabled', true);
                }
            });
        });
    </script>
</body>

</html>