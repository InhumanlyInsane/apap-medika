<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://thymeleaf.org">

<head>
    <meta charset="UTF-2">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css" />
    <link rel="stylesheet" th:href="@{/css/bootstrap.min.css}">
    <script th:src="@{/js/bootstrap.bundle.min.js}"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>

    <title>APAP Medika</title>

    <object th:include="~{fragments/common :: js}" th:remove="tag "></object>
    <object th:include="~{fragments/common :: css}" th:remove="tag "></object>
</head>

<body>
    <nav th:replace="~{fragments/navbar :: navbar}"></nav>

    <div class="container mt-5 mb-5">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-body">
                        <h2 class="text-center mb-4">New Patient & Appointment</h2>
                        <form method="POST" th:action="@{/appointment/create-with-patient}" th:object="${wrapperDTO}">
                            <!-- Patient Information -->
                            <div class="row">
                                <div class="mb-3 col-md-4">
                                    <label for="name" class="form-label">Name</label>
                                    <input type="text" class="form-control" th:field="*{patientDTO.name}" id="name" required>
                                </div>
                                <div class="mb-3 col-md-4">
                                    <label for="nik" class="form-label">NIK</label>
                                    <input type="text" class="form-control" th:field="*{patientDTO.nik}" id="nik" required>
                                </div>
                                <div class="mb-3 col-md-4">
                                    <label for="email" class="form-label">Email</label>
                                    <input type="email" class="form-control" th:field="*{patientDTO.email}" id="email" required>
                                </div>
                                <div class="mb-3 col-md-4">
                                    <label class="form-label">Gender</label>
                                    <div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" id="male" th:field="*{patientDTO.gender}" value="true" required>
                                            <label class="form-check-label" for="male">Male</label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" id="female" th:field="*{patientDTO.gender}" value="false">
                                            <label class="form-check-label" for="female">Female</label>
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3 col-md-4">
                                    <label for="dateOfBirth" class="form-label">Date of Birth</label>
                                    <input type="date" class="form-control" th:field="*{patientDTO.birthDate}" id="dateOfBirth" required>
                                </div>
                                <div class="mb-3 col-md-4">
                                    <label for="birthPlace" class="form-label">Birth Place</label>
                                    <input type="text" class="form-control" th:field="*{patientDTO.birthPlace}" id="birthPlace" required>
                                </div>
                            </div>

                            <hr>

                            <!-- Appointment Information -->
                            <div class="mb-3">
                                <label for="doctor" class="form-label">Doctor</label>
                                <select class="form-select" id="doctor" name="doctorId" th:field="*{appointmentDTO.doctorId}">
                                    <option value="">Select a doctor</option>
                                    <option th:each="doctor : ${allDoctors}" th:value="${doctor.id}"
                                        th:text="${doctor.name}" th:data-schedule="${doctor.schedule}"></option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="schedule" class="form-label">Schedule</label>
                                <select class="form-select" id="schedule" name="scheduleDate" disabled th:field="*{appointmentDTO.appointmentDate}">
                                    <option value="">Select a schedule</option>
                                </select>
                            </div>

                            <div class="mb-3">
                                <button type="submit" class="btn btn-primary">Submit</button>
                                <a class="btn btn-danger" th:href="@{/appointment/all}">Cancel</a>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script th:inline="javascript">
        const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
        const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
        
        function getNextFourWeeks(dayOfWeek) {
            const today = new Date();
            const dates = [];
            let current = new Date(today.getTime());
            current.setDate(today.getDate() + (dayOfWeek - today.getDay() + 7) % 7);
            
            for (let i = 0; i < 4; i++) {
                dates.push(new Date(current.getTime()));
                current.setDate(current.getDate() + 7);
            }
            
            return dates;
        }
        
        function formatDate(date) {
            const dayName = dayNames[date.getDay()];
            const day = date.getDate();
            const month = monthNames[date.getMonth()];
            const year = date.getFullYear();
            return `${dayName}, ${day} ${month} ${year}`;
        }
        
        $(document).ready(function() {
            $('#doctor').change(function() {
                const scheduleSelect = $('#schedule');
                scheduleSelect.empty().append('<option value="">Select a schedule</option>');
                
                const selectedOption = $(this).find('option:selected');
                const schedule = selectedOption.data('schedule');
                
                if (schedule && schedule.length > 0) {
                    const fourWeekDates = [];
                    schedule.forEach(day => {
                        const dates = getNextFourWeeks(day);
                        fourWeekDates.push(...dates);
                    });
                    
                    fourWeekDates.sort((a, b) => a - b);
                    
                    fourWeekDates.forEach(date => {
                        const formattedDate = formatDate(date);
                        scheduleSelect.append(`<option value="${date.toISOString()}">${formattedDate}</option>`);
                    });
                    scheduleSelect.prop('disabled', false);
                } else {
                    scheduleSelect.prop('disabled', true);
                }
            });
        });
    </script>
</body>

</html>