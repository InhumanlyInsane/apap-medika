<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <title>APAP Medika</title>
    <object th:include="~{fragments/common :: css}" th:remove="tag"></object>
    <object th:include="~{fragments/common :: js}" th:remove="tag"></object>
</head>

<body>
    <nav th:replace="~{fragments/navbar :: navbar}"></nav>

    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-body">
                        <h2 class="text-center mb-4">Update Appointment</h2>
                        <form th:action="@{/appointment/update}" th:object="${appointmentDTO}" method="POST">
                            <input type="hidden" th:field="*{id}">
                            <div class="mb-3">
                                <label for="appointmentId" class="form-label fw-bold">ID</label>
                                <input type="text" id="appointmentId" class="form-control" readonly disabled th:value="*{id}">
                            </div>
                            <div class="mb-3">
                                <label for="doctor" class="form-label fw-bold">Doctor</label>
                                <select class="form-select" id="doctor" th:field="*{doctorId}">
                                    <option th:each="doctor : ${allDoctors}" th:value="${doctor.id}"
                                        th:text="${doctor.name}" th:data-schedule="${doctor.schedule}"
                                        th:selected="${doctor.id == appointmentDTO.doctorId}"></option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="schedule" class="form-label fw-bold">Schedule</label>
                                <select class="form-select" id="schedule" th:field="*{appointmentDate}">
                                    <option th:value="${appointmentDTO.appointmentDate}" 
                                            th:text="${formattedAppointmentDate}" 
                                            selected></option>
                                </select>
                            </div>

                            <div class="mb-3">
                                <button type="submit" class="btn btn-primary">Update</button>
                                <a class="btn btn-danger" th:href="@{/appointment/all}">Cancel</a>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script th:inline="javascript">
        const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
        const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];

        function getNextFourWeeks(dayOfWeek) {
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Set to beginning of day for accurate comparison
            const dates = [];
            let current = new Date(today.getTime());
            
            // Find the next occurrence of the specified day of the week
            current.setDate(current.getDate() + (dayOfWeek - current.getDay() + 7) % 7);
            
            for (let i = 0; i < 4; i++) {
                if (current >= today) {
                    dates.push(new Date(current.getTime()));
                }
                current.setDate(current.getDate() + 7);
            }
            
            return dates;
        }

        function formatDate(date) {
            const dayName = dayNames[date.getDay()];
            const day = date.getDate();
            const month = monthNames[date.getMonth()];
            const year = date.getFullYear();
            return `${dayName}, ${day} ${month} ${year}`;
        }

        $(document).ready(function() {
            const currentAppointmentDate = new Date(/*[[${appointmentDTO.appointmentDate}]]*/ null);
            
            function populateSchedule() {
                const scheduleSelect = $('#schedule');
                const selectedOption = $('#doctor').find('option:selected');
                const schedule = selectedOption.data('schedule');
                
                // Keep the current appointment date as the first option if it exists
                const currentDateOption = scheduleSelect.find('option:first');
                scheduleSelect.empty();
                if (currentDateOption.length && currentDateOption.val() !== "") {
                    scheduleSelect.append(currentDateOption);
                } else {
                    scheduleSelect.append('<option value="">Select a schedule</option>');
                }
                
                if (schedule && schedule.length > 0) {
                    const fourWeekDates = [];
                    schedule.forEach(day => {
                        const dates = getNextFourWeeks(day);
                        fourWeekDates.push(...dates);
                    });
                    
                    fourWeekDates.sort((a, b) => a - b);
                    
                    const today = new Date();
                    today.setHours(0, 0, 0, 0); // Set to beginning of day for accurate comparison
                    
                    fourWeekDates.forEach(date => {
                        if (date >= today && (!currentAppointmentDate || date.toDateString() !== currentAppointmentDate.toDateString())) {
                            const formattedDate = formatDate(date);
                            const isoDate = date.toISOString();
                            scheduleSelect.append(`<option value="${isoDate}">${formattedDate}</option>`);
                        }
                    });
                    scheduleSelect.prop('disabled', false);
                } else {
                    scheduleSelect.prop('disabled', true);
                }
            }

            $('#doctor').change(populateSchedule);
            
            // Initial population of schedule
            populateSchedule();
        });
    </script>

</body>

</html>